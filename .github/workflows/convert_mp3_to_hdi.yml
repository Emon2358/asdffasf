name: Build PC-98 HDI with WAV Player

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: sudo apt-get install -y mtools ffmpeg unzip zip

      - name: Unzip HDI File
        run: unzip hdd40.zip

      - name: Convert MP3 to WAV
        run: |
          ffmpeg -i input.mp3 -ac 1 -ar 22050 -f wav -bitexact output.wav

      - name: Download WPLAY
        run: |
          curl -L -o WPLAY.COM https://nfggames.com/forum2/index.php?action=dlattach;topic=5607.0;attach=1210

      - name: Create Batch File
        run: echo "WPLAY output.wav" > playwav.bat

      - name: Insert files into HDI
        run: |
          cp "hdd40(boot)(win3.1 Installed).hdi" hdd40_final.hdi
          mcopy -i hdd40_final.hdi WPLAY.COM ::/
          mcopy -i hdd40_final.hdi output.wav ::/
          mcopy -i hdd40_final.hdi playwav.bat ::/

      - name: Compress Final HDI
        run: zip hdd40_final.zip hdd40_final.hdi

      - name: Upload HDI Artifact
        uses: actions/upload-artifact@v3
        with:
          name: pc98-disk-image
          path: hdd40_final.zip
