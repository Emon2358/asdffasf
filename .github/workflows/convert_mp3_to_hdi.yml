name: Convert MP3 to HDI

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y mtools
          sudo apt-get install -y zip
          sudo apt-get install -y dosfstools

      - name: Create HDI and copy MP3 files
        run: |
          HDI_FILE="output.img"
          MP3_FILES=$(find . -name "*.mp3")

          # Create an empty 10MB image file
          dd if=/dev/zero of=$HDI_FILE bs=1M count=10

          # Create a FAT file system
          mkfs.msdos $HDI_FILE

          # Copy MP3 files to the HDI
          mcopy -i $HDI_FILE $MP3_FILES ::/

      - name: Check HDI file size
        id: check_size
        run: |
          SIZE=$(stat -c%s "output.img")
          echo "HDI file size: $SIZE bytes"
          echo "::set-output name=size::$SIZE"

      - name: Create a new release
        id: create_release
        run: |
          TAG="v1.0.0"
          # Check if release already exists, skip creation if it does
          gh release view $TAG || gh release create $TAG --title "Release $TAG" --notes "Automated release"

      - name: Upload HDI or ZIP
        run: |
          # Fix comparison for file size condition
          if [ "${{ steps.check_size.outputs.size }}" -gt 10485760 ]; then
            echo "HDI file is too large, compressing to ZIP"
            zip output.zip output.img
            echo "Uploading ZIP file"
            gh release upload "v1.0.0" output.zip
          else
            echo "Uploading HDI file"
            gh release upload "v1.0.0" output.img
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
